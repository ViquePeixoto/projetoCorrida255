<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro</title>
    <link rel="stylesheet" href="/css/style.css">
</head>

<body class="corpoPrincipal">

    <section id="secaoSideBar" class="sideBar container">

        <a href="./visitanteTorneio.html">
            <i class="fas fa-flag-checkered" title="Torneios"></i>
        </a>

        <a href="./usuarioRanking.html">
            <i class="fas fa-person-running" title="Corredores"></i>
        </a>

        <a href="./usuarioLogin.html">
            <i class="fas fa-warehouse" title="Login"></i>
        </a>

    </section>

    <main class="secaoPrincipal margemCadastro">

        <section class="secaoFormulario margemCadastro">

            <p>NOME DE USUÁRIO</p>
            <input id="inputNome" class="inputsValidacao" type="text" placeholder="Insira o seu nome."
                oninput="validarNome()">

            <p>E-MAIL</p>
            <input id="inputEmail" class="inputsValidacao" type="email" placeholder="Insira o seu e-mail."
                oninput="validarEmail()">

            <p>SENHA</p>
            <input id="inputSenha" class="inputsValidacao" type="password" placeholder="Insira a sua senha."
                oninput="validarSenha()">

            <a href="./usuarioLogin.html">Já tenho uma conta.</a>
            <button class="botaoValidacao" onclick="verificarCriacaoDeConta()">Criar conta</button>

        </section>

        <div id="divVerificacaoDeConta" class="mensagemValidacao"></div>

    </main>

    <div class="barraRolante">

        <span id="spanFlavorText"></span>

    </div>

</body>

</html>

<!-- Barra rolante. -->
<script src="../script/barra_rolante.js"></script>

<!-- Cadastro. -->
<script>

    var listaDeSimbolosEspeciais = ['.', ',', '+', '-', '_', '(', '!', '@', '>', '?', '/', ')', '#', '$', ':', '|', '<', '%', '^', '{', '}', ';', '&', '*', '=', '[', ']'];

    function exibirMensagem(msg) {
        var div = document.getElementById("divVerificacaoDeConta");
        div.innerHTML = msg;
        div.classList.remove("mensagemValidacaoAtivo");
        void div.offsetWidth; // reflow para resetar animação
        div.classList.add("mensagemValidacaoAtivo");
        setTimeout(() => div.classList.remove("mensagemValidacaoAtivo"), 2000);
    }

    function validarNome() {
        var nome = inputNome.value;
        for (let i = 0; i < nome.length; i++) {
            if (listaDeSimbolosEspeciais.includes(nome[i])) {
                exibirMensagem("Permitimos de tudo, mas cuidado com os símbolos especiais.");
                return false;
            }
        }
        return true;
    }

    function validarEmail() {
        var email = inputEmail.value;
        if (!email.includes('@')) {
            exibirMensagem("Seu e-mail não contém um @... Ainda.");
            return false;
        }
        return true;
    }

    function validarSenha() {
        var senha = inputSenha.value;
        let temMaiuscula = false, temMinuscula = false, temNumero = false, temSimbolo = false;

        for (let i = 0; i < senha.length; i++) {
            var c = senha[i];
            if (c >= 'A' && c <= 'Z') temMaiuscula = true;
            else if (c >= 'a' && c <= 'z') temMinuscula = true;
            else if (c >= '0' && c <= '9') temNumero = true;
            else if (listaDeSimbolosEspeciais.includes(c)) temSimbolo = true;
        }

        if (!(temMaiuscula && temMinuscula && temNumero && temSimbolo)) {
            exibirMensagem("Para sua segurança, use letras maiúsculas, minúsculas, números e símbolos.");
            return false;
        }
        return true;
    }

    function verificarCriacaoDeConta() {
        var nome = inputNome.value.trim();
        var email = inputEmail.value.trim();
        var senha = inputSenha.value.trim();

        if (!nome || !email || !senha) {
            exibirMensagem("Sem campos vazios!");
            return false;
        }

        if (!validarNome() || !validarEmail() || !validarSenha()) return false;

        fetch("/usuarios/cadastrar", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ nomeServer: nome, emailServer: email, senhaServer: senha })
        })
            .then(res => {
                if (res.ok) {
                    exibirMensagem("Cadastro feito, agora é só fazer login...");
                    setTimeout(() => window.location = "./usuarioLogin.html", 2000);
                } else {
                    res.text().then(t => exibirMensagem("Erro ao cadastrar: " + t));
                }
            })
            .catch(err => {
                console.error("Erro no fetch:", err);
                exibirMensagem("Erro inesperado. Tente novamente mais tarde.");
            });

        return false;
    }
</script>